# -----------------------------------------------------------------------------
# Blk4_UserTimerProgram.yaml
#
# Purpose:
#   ESPHome configuration for reading and decoding machine parameters (Block 4/5/6/7)
#   from a Sabiana VMC controller via Modbus. Provides sensors, binary sensors,
#   and text sensors for various machine parameters, limits, offsets, and settings.
#
# Structure:
#   - text_sensor: User timer program
#   - modbus_controller: Reads and parses the Block 4 register map (address 0x0400)
#
# Notes:
#   - The modbus_controller sensor reads 119 bytes and parses them into the above fields.
#   - Helper functions like readSigned16ToFloat, readBitFromUns16, etc. are assumed to be defined elsewhere.
# -----------------------------------------------------------------------------

substitutions:
  prefixBlk4: "Blk4 - "

# Templates

.raw_user_timer_program: &raw_user_timer_program
  modbus_controller_id: sabiana_vmc_schedules
  register_type: holding
  register_count: 119
  response_size: 238
  internal: true
  value_type: U_WORD
.text_user_timer_program: &text_user_timer_program
  icon: mdi:code-json
  update_interval: never

sensor:
  - platform: modbus_controller
    id: blk4_user_timer_program_1
    name: "${prefixBlk4} User Timer Program 1 Data"
    address: 0x0400
    <<: *raw_user_timer_program
    lambda: |-
      if (data.size() != 238) {
        ESP_LOGW("modbus", "Block 4 - User Timer Program 1 - Dimensione risposta errata: %d", data.size());
        return NAN;
      }

      id(blk4_user_timer_program_1_day1).publish_state(parse_user_timer_program(data, 1, 1));
      id(blk4_user_timer_program_1_day2).publish_state(parse_user_timer_program(data, 1, 2));
      id(blk4_user_timer_program_1_day3).publish_state(parse_user_timer_program(data, 1, 3));
      id(blk4_user_timer_program_1_day4).publish_state(parse_user_timer_program(data, 1, 4));
      id(blk4_user_timer_program_1_day5).publish_state(parse_user_timer_program(data, 1, 5));
      id(blk4_user_timer_program_1_day6).publish_state(parse_user_timer_program(data, 1, 6));
      id(blk4_user_timer_program_1_day7).publish_state(parse_user_timer_program(data, 1, 7));
      return data.size() / 2; // Return readed register count

  - platform: modbus_controller
    id: blk4_user_timer_program_2
    name: "${prefixBlk4} User Timer Program 2 Data"
    address: 0x0500
    <<: *raw_user_timer_program
    lambda: |-
      if (data.size() != 238) {
        ESP_LOGW("modbus", "Block 4 - User Timer Program 2 - Dimensione risposta errata: %d", data.size());
        return NAN;
      }

      id(blk4_user_timer_program_2_day1).publish_state(parse_user_timer_program(data, 2, 1));
      id(blk4_user_timer_program_2_day2).publish_state(parse_user_timer_program(data, 2, 2));
      id(blk4_user_timer_program_2_day3).publish_state(parse_user_timer_program(data, 2, 3));
      id(blk4_user_timer_program_2_day4).publish_state(parse_user_timer_program(data, 2, 4));
      id(blk4_user_timer_program_2_day5).publish_state(parse_user_timer_program(data, 2, 5));
      id(blk4_user_timer_program_2_day6).publish_state(parse_user_timer_program(data, 2, 6));
      id(blk4_user_timer_program_2_day7).publish_state(parse_user_timer_program(data, 2, 7));
      return data.size() / 2; // Return readed register count

  - platform: modbus_controller
    id: blk4_user_timer_program_3
    name: "${prefixBlk4} User Timer Program 3 Data"
    address: 0x0600
    <<: *raw_user_timer_program
    lambda: |-
      if (data.size() != 238) {
        ESP_LOGW("modbus", "Block 4 - User Timer Program 3 - Dimensione risposta errata: %d", data.size());
        return NAN;
      }

      id(blk4_user_timer_program_3_day1).publish_state(parse_user_timer_program(data, 3, 1));
      id(blk4_user_timer_program_3_day2).publish_state(parse_user_timer_program(data, 3, 2));
      id(blk4_user_timer_program_3_day3).publish_state(parse_user_timer_program(data, 3, 3));
      id(blk4_user_timer_program_3_day4).publish_state(parse_user_timer_program(data, 3, 4));
      id(blk4_user_timer_program_3_day5).publish_state(parse_user_timer_program(data, 3, 5));
      id(blk4_user_timer_program_3_day6).publish_state(parse_user_timer_program(data, 3, 6));
      id(blk4_user_timer_program_3_day7).publish_state(parse_user_timer_program(data, 3, 7));
      return data.size() / 2; // Return readed register count

  - platform: modbus_controller
    id: blk4_user_timer_program_4
    name: "${prefixBlk4} User Timer Program 4 Data"
    address: 0x0700
    <<: *raw_user_timer_program
    lambda: |-
      if (data.size() != 238) {
        ESP_LOGW("modbus", "Block 4 - User Timer Program 4 - Dimensione risposta errata: %d", data.size());
        return NAN;
      }

      id(blk4_user_timer_program_4_day1).publish_state(parse_user_timer_program(data, 4, 1));
      id(blk4_user_timer_program_4_day2).publish_state(parse_user_timer_program(data, 4, 2));
      id(blk4_user_timer_program_4_day3).publish_state(parse_user_timer_program(data, 4, 3));
      id(blk4_user_timer_program_4_day4).publish_state(parse_user_timer_program(data, 4, 4));
      id(blk4_user_timer_program_4_day5).publish_state(parse_user_timer_program(data, 4, 5));
      id(blk4_user_timer_program_4_day6).publish_state(parse_user_timer_program(data, 4, 6));
      id(blk4_user_timer_program_4_day7).publish_state(parse_user_timer_program(data, 4, 7));
      return data.size() / 2; // Return readed register count

text_sensor:

  # Program 1
  - platform: template
    name: "${prefixBlk4}User timer program 1 - Day 1"
    id: blk4_user_timer_program_1_day1
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 1 - Day 2"
    id: blk4_user_timer_program_1_day2
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 1 - Day 3"
    id: blk4_user_timer_program_1_day3
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 1 - Day 4"
    id: blk4_user_timer_program_1_day4
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 1 - Day 5"
    id: blk4_user_timer_program_1_day5
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 1 - Day 6"
    id: blk4_user_timer_program_1_day6
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 1 - Day 7"
    id: blk4_user_timer_program_1_day7

  # Program 2
  - platform: template
    name: "${prefixBlk4}User timer program 2 - Day 1"
    id: blk4_user_timer_program_2_day1
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 2 - Day 2"
    id: blk4_user_timer_program_2_day2
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 2 - Day 3"
    id: blk4_user_timer_program_2_day3
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 2 - Day 4"
    id: blk4_user_timer_program_2_day4
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 2 - Day 5"
    id: blk4_user_timer_program_2_day5
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 2 - Day 6"
    id: blk4_user_timer_program_2_day6
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 2 - Day 7"
    id: blk4_user_timer_program_2_day7
    <<: *text_user_timer_program

  # Program 3
  - platform: template
    name: "${prefixBlk4}User timer program 3 - Day 1"
    id: blk4_user_timer_program_3_day1
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 3 - Day 2"
    id: blk4_user_timer_program_3_day2
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 3 - Day 3"
    id: blk4_user_timer_program_3_day3
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 3 - Day 4"
    id: blk4_user_timer_program_3_day4
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 3 - Day 5"
    id: blk4_user_timer_program_3_day5
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 3 - Day 6"
    id: blk4_user_timer_program_3_day6
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 3 - Day 7"
    id: blk4_user_timer_program_3_day7
    <<: *text_user_timer_program

  # Program 4
  - platform: template
    name: "${prefixBlk4}User timer program 4 - Day 1"
    id: blk4_user_timer_program_4_day1
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 4 - Day 2"
    id: blk4_user_timer_program_4_day2
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 4 - Day 3"
    id: blk4_user_timer_program_4_day3
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 4 - Day 4"
    id: blk4_user_timer_program_4_day4
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 4 - Day 5"
    id: blk4_user_timer_program_4_day5
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 4 - Day 6"
    id: blk4_user_timer_program_4_day6
    <<: *text_user_timer_program
  - platform: template
    name: "${prefixBlk4}User timer program 4 - Day 7"
    id: blk4_user_timer_program_4_day7
    <<: *text_user_timer_program

api:
  services:
    - service: blk4_user_timer_program_refresh
      then:
        - logger.log: "Refreshing all schedule programs"
        - lambda: |-
            id(sabiana_vmc_schedules)->update();
    
    - service: blk4_user_timer_program_write
      variables:
        program_number: int    # 1-4
        day1_json: string
        day2_json: string
        day3_json: string
        day4_json: string
        day5_json: string
        day6_json: string
        day7_json: string
      then:
        - lambda: |-
            ESP_LOGI("write_schedule", "Writing program %d", program_number);
            
            // Calcola indirizzo base
            uint16_t base_addr;
            switch (program_number) {
              case 1: base_addr = 0x0400; break;
              case 2: base_addr = 0x0500; break;
              case 3: base_addr = 0x0600; break;
              case 4: base_addr = 0x0700; break;
              default:
                ESP_LOGE("write_schedule", "Invalid program: %d", program_number);
                return;
            }
            
            // Crea array con i 7 giorni
            std::vector<std::string> days;
            days.push_back(day1_json);
            days.push_back(day2_json);
            days.push_back(day3_json);
            days.push_back(day4_json);
            days.push_back(day5_json);
            days.push_back(day6_json);
            days.push_back(day7_json);
            
            // Scrivi tutto
            if (write_complete_schedule(id(sabiana_vmc_schedules), base_addr, days)) {
              ESP_LOGI("write_schedule", "SUCCESS");
            } else {
              ESP_LOGE("write_schedule", "FAILED");
            }